// WhatsApp number
        const whatsappNumber = "242068196522";
        
        // Données produits avec ville et stock
        const products = [
            {
                id: 1,
                title: "Robe élégante",
                category: "vetements",
                price: 15000,
                promoPrice: 12000,
                image: "https://via.placeholder.com/600x800?text=Robe+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Robe+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Robe+Cowema+2",
                    "https://via.placeholder.com/600x800?text=Robe+Cowema+3"
                ],
                description: "Robe élégante pour toutes occasions. Matière douce et confortable. Disponible en plusieurs coloris. Taille unique, ajustable avec ceinture incluse.",
                city: "Brazzaville",
                stock: 5,
                sold: 12
            },
            {
                id: 2,
                title: "Collier doré",
                category: "accessoires",
                price: 8000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Collier+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Collier+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Collier+Cowema+2"
                ],
                description: "Collier en or 18 carats. Design moderne et élégant. Parfait pour compléter votre tenue. Longueur ajustable entre 40cm et 45cm.",
                city: "Pointe-Noire",
                stock: 12,
                sold: 25
            },
                {
                id: 2,
                title: "Collier doré",
                category: "accessoires",
                price: 8000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Collier+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Collier+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Collier+Cowema+2"
                ],
                description: "Collier en or 18 carats. Design moderne et élégant. Parfait pour compléter votre tenue. Longueur ajustable entre 40cm et 45cm.",
                city: "Pointe-Noire",
                stock: 12,
                sold: 25
            },
                {
                id: 2,
                title: "Collier doré",
                category: "accessoires",
                price: 8000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Collier+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Collier+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Collier+Cowema+2"
                ],
                description: "Collier en or 18 carats. Design moderne et élégant. Parfait pour compléter votre tenue. Longueur ajustable entre 40cm et 45cm.",
                city: "Pointe-Noire",
                stock: 12,
                sold: 25
            },
                {
                id: 2,
                title: "Collier doré",
                category: "accessoires",
                price: 8000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Collier+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Collier+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Collier+Cowema+2"
                ],
                description: "Collier en or 18 carats. Design moderne et élégant. Parfait pour compléter votre tenue. Longueur ajustable entre 40cm et 45cm.",
                city: "Pointe-Noire",
                stock: 12,
                sold: 25
            },
            {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
                {
                id: 4,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
            
            {
                id: 4,
                title: "Bracelet argent",
                category: "accessoires",
                price: 6000,
                promoPrice: 5000,
                image: "https://via.placeholder.com/600x800?text=Bracelet+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Bracelet+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Bracelet+Cowema+2"
                ],
                description: "Bracelet en argent 925 avec fermoir sécurisé. Design minimaliste et élégant. Convient pour tous les jours ou occasions spéciales.",
                city: "Dolisie",
                stock: 3,
                sold: 8
            },
                {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
            {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
            {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
            {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
            {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
            {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
            {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
            {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },

            {
                id: 3,
                title: "Chemise homme",
                category: "vetements",
                price: 9000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Chemise+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Chemise+Cowema+2"
                ],
                description: "Chemise élégante pour homme. 100% coton. Lavage en machine facile. Disponible en tailles S, M, L, XL. Couleurs disponibles : blanc, bleu, gris.",
                city: "Brazzaville",
                stock: 8,
                sold: 15
            },
            {
                id: 5,
                title: "Sandales été",
                category: "chaussures",
                price: 12000,
                promoPrice: 10000,
                image: "https://via.placeholder.com/600x800?text=Sandales+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+2"
                ],
                description: "Sandales confortables pour l'été. Semelle antidérapante. Disponible du 36 au 42. Matière : cuir synthétique résistant à l'eau.",
                city: "Pointe-Noire",
                stock: 7,
                sold: 18
            },

            {
                id: 5,
                title: "Sandales été",
                category: "chaussures",
                price: 12000,
                promoPrice: 10000,
                image: "https://via.placeholder.com/600x800?text=Sandales+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+2"
                ],
                description: "Sandales confortables pour l'été. Semelle antidérapante. Disponible du 36 au 42. Matière : cuir synthétique résistant à l'eau.",
                city: "Pointe-Noire",
                stock: 7,
                sold: 18
            },
            {
                id: 5,
                title: "Sandales été",
                category: "chaussures",
                price: 12000,
                promoPrice: 10000,
                image: "https://via.placeholder.com/600x800?text=Sandales+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+2"
                ],
                description: "Sandales confortables pour l'été. Semelle antidérapante. Disponible du 36 au 42. Matière : cuir synthétique résistant à l'eau.",
                city: "Pointe-Noire",
                stock: 7,
                sold: 18
            },
            {
                id: 5,
                title: "Sandales été",
                category: "chaussures",
                price: 12000,
                promoPrice: 10000,
                image: "https://via.placeholder.com/600x800?text=Sandales+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+2"
                ],
                description: "Sandales confortables pour l'été. Semelle antidérapante. Disponible du 36 au 42. Matière : cuir synthétique résistant à l'eau.",
                city: "Pointe-Noire",
                stock: 7,
                sold: 18
            },
            {
                id: 5,
                title: "Sandales été",
                category: "chaussures",
                price: 12000,
                promoPrice: 10000,
                image: "https://via.placeholder.com/600x800?text=Sandales+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Sandales+Cowema+2"
                ],
                description: "Sandales confortables pour l'été. Semelle antidérapante. Disponible du 36 au 42. Matière : cuir synthétique résistant à l'eau.",
                city: "Pointe-Noire",
                stock: 7,
                sold: 18
            },
            {
                id: 6,
                title: "Jupe africaine",
                category: "vetements",
                price: 11000,
                promoPrice: 9500,
                image: "https://via.placeholder.com/600x800?text=Jupe+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Jupe+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Jupe+Cowema+2"
                ],
                description: "Jupe africaine en wax de haute qualité. Motifs traditionnels. Taille unique avec élastique à la taille pour un ajustement parfait.",
                city: "Brazzaville",
                stock: 4,
                sold: 9
            },
            {
                id: 7,
                title: "Boucles d'oreilles",
                category: "accessoires",
                price: 5000,
                promoPrice: null,
                image: "https://via.placeholder.com/600x800?text=Boucles+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Boucles+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Boucles+Cowema+2"
                ],
                description: "Boucles d'oreilles en métal doré avec motifs géométriques. Fermoir à vis pour une sécurité optimale. Poids léger pour un confort optimal.",
                city: "Nkayi",
                stock: 15,
                sold: 30
            },
            {
                id: 8,
                title: "Baskets",
                category: "chaussures",
                price: 18000,
                promoPrice: 15000,
                image: "https://via.placeholder.com/600x800?text=Baskets+Cowema",
                images: [
                    "https://via.placeholder.com/600x800?text=Baskets+Cowema+1",
                    "https://via.placeholder.com/600x800?text=Baskets+Cowema+2"
                ],
                description: "Baskets urbaines unisexes. Semelle en caoutchouc antidérapante. Doublure intérieure confortable. Disponible en tailles 38-44. Couleurs : noir, blanc, bleu.",
                city: "Brazzaville",
                stock: 6,
                sold: 14
            }
        ];

        // Frais de livraison par ville et quartier
        const deliveryFees = {
            "Brazzaville": {
                "Makélékélé": 1000,
                "Bacongo": 1000,
                "Poto-Poto": 1000,
                "Moungali": 1000,
                "Ouenzé": 1000,
                "Talangaï":1500,
                "Mfilou": 1000,
                "Djiri":2000,
                "Mayanga": 1500,
                "Midibou": 2000,
                "Kombe": 2000,
                "Nganga Lingolo": 2000,
            },
            "Pointe-Noire": {
                "Lumumba": 1000,
                "Mvou-Mvou": 1500,
                "Tié-Tié": 1500,
                "Loandjili": 1500,
                "Mongo Mpoukou": 1000,
                "Ngoyo": 1500,
            },
            "Dolisie": {
                "Centre-ville": 2000,
                "Autre": 2500
            },
            "Nkayi": {
                "Centre-ville": 2000,
                "Autre": 2500
            },
            "Autre": {
                "Autre": 5000
            }
        };

        // Variables globales
        let currentProductForPurchase = null;
        let currentCategory = 'all';
        let currentSearch = '';
        let cart = [];
        
        // Simuler une base de données utilisateurs
        let users = JSON.parse(localStorage.getItem('cowema_users')) || [];
        let currentUser = JSON.parse(localStorage.getItem('cowema_currentUser')) || null;
        
        // Éléments du DOM
        const searchBox = document.getElementById('searchBox');
        const categoriesContainer = document.getElementById('categoriesContainer');
        const productsByCategory = document.getElementById('productsByCategory');
        
        // Modals
        const productModal = document.getElementById('productModal');
        const productModalBody = document.getElementById('productModalBody');
        const deliveryFormModal = document.getElementById('deliveryFormModal');
        const deliveryInfoForm = document.getElementById('deliveryInfoForm');
        const skipDeliveryBtn = document.getElementById('skipDeliveryBtn');
        
        // Panier
        const cartBtn = document.getElementById('cartBtn');
        const headerCartBtn = document.getElementById('headerCartBtn');
        const cartModal = document.getElementById('cartModal');
        const cartItems = document.getElementById('cartItems');
        const cartCount = document.getElementById('cartCount');
        const headerCartCount = document.getElementById('headerCartCount');
        const cartTotal = document.getElementById('cartTotal');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        
        // Abandon de panier
        const cartAbandonModal = document.getElementById('cartAbandonModal');
        const viewCartBtn = document.getElementById('viewCartBtn');
        
        // Chat WhatsApp
        const whatsappChatBtn = document.querySelector('.whatsapp-chat a');
        const chatTooltip = document.querySelector('.chat-tooltip');

        // Fermeture des modals
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                modal.style.display = 'none';
            });
        });
        
        // Initialisation
        function init() {
            displayCategories();
            displayProductsByCategory();
            setupEventListeners();
            updateCart();
            setupWhatsAppChat();
            setupCartAbandonment();
            updateAuthUI();
            setupLeadCapture();
        }

        // Afficher les catégories
        function displayCategories() {
            // Récupérer toutes les catégories uniques
            const categories = ['all', ...new Set(products.map(product => product.category))];
            
            categoriesContainer.innerHTML = '';
            
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                if (category === 'all') button.classList.add('active');
                button.setAttribute('data-category', category);
                
                // Formater le texte de la catégorie
                let categoryText = category;
                if (category === 'all') categoryText = 'Tous les produits';
                else if (category === 'vetements') categoryText = 'Vêtements';
                else if (category === 'accessoires') categoryText = 'Accessoires';
                else if (category === 'chaussures') categoryText = 'Chaussures';
                
                button.textContent = categoryText;
                categoriesContainer.appendChild(button);
            });
        }

        // Afficher les produits groupés par catégorie
        function displayProductsByCategory() {
            productsByCategory.innerHTML = '';
            
            // Filtrer les produits selon la recherche et la catégorie
            const filteredProducts = products.filter(product => {
                const matchesCategory = currentCategory === 'all' || product.category === currentCategory;
                const matchesSearch = product.title.toLowerCase().includes(currentSearch.toLowerCase());
                return matchesCategory && matchesSearch;
            });
            
            // Grouper par catégorie
            const productsGrouped = {};
            filteredProducts.forEach(product => {
                if (!productsGrouped[product.category]) {
                    productsGrouped[product.category] = [];
                }
                productsGrouped[product.category].push(product);
            });
            
            // Si "Tous les produits", afficher toutes les catégories avec leurs produits
            if (currentCategory === 'all') {
                for (const category in productsGrouped) {
                    const section = createCategorySection(category, productsGrouped[category]);
                    productsByCategory.appendChild(section);
                }
            } 
            // Si une catégorie spécifique, afficher tous les produits de cette catégorie
            else {
                const section = createCategorySection(currentCategory, productsGrouped[currentCategory] || [], false);
                productsByCategory.appendChild(section);
            }
            
            // Si aucun produit trouvé
            if (filteredProducts.length === 0) {
                productsByCategory.innerHTML = '<p style="text-align: center; padding: 40px;">Aucun produit trouvé.</p>';
            }
            
            // Mettre à jour les événements
            updateEventListeners();
        }
        
        // Créer une section de catégorie
        function createCategorySection(category, products, showViewMore = true) {
            const section = document.createElement('div');
            section.className = 'products-section';
            
            // Titre de la catégorie
            const titleContainer = document.createElement('div');
            titleContainer.className = 'section-title';
            
            let categoryText = category;
            if (category === 'vetements') categoryText = 'Vêtements';
            else if (category === 'accessoires') categoryText = 'Accessoires';
            else if (category === 'chaussures') categoryText = 'Chaussures';
            
            const title = document.createElement('h2');
            title.textContent = categoryText;
            titleContainer.appendChild(title);
            
            // Lien "Voir plus" seulement si nécessaire et en mode "Tous"
            if (showViewMore && currentCategory === 'all' && products.length > 12) {
                const viewMoreLink = document.createElement('a');
                viewMoreLink.className = 'view-more';
                viewMoreLink.href = '#';
                viewMoreLink.innerHTML = 'Voir plus <i class="fas fa-arrow-right"></i>';
                viewMoreLink.setAttribute('data-category', category);
                titleContainer.appendChild(viewMoreLink);
            }
            
            section.appendChild(titleContainer);
            
            // Conteneur des produits
            const productsContainer = document.createElement('div');
            productsContainer.className = 'products';
            
            // Limiter à 4 produits seulement en mode "Tous"
            const productsToShow = currentCategory === 'all' ? 
                products.slice(0, 12): 
                products;
            
            // Ajouter chaque produit
            productsToShow.forEach(product => {
                const productCard = createProductCard(product);
                productsContainer.appendChild(productCard);
            });
            
            section.appendChild(productsContainer);
            return section;
        }
        
        // Créer une carte produit
        function createProductCard(product) {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            
            const priceHTML = product.promoPrice 
                ? `<div class="price-container">
                        <span class="current-price">${product.promoPrice.toLocaleString()} FCFA</span>
                        <span class="old-price">${product.price.toLocaleString()} FCFA</span>
                    </div>`
                : `<div class="price-container">
                        <span class="current-price">${product.price.toLocaleString()} FCFA</span>
                    </div>`;
            
            // Badge de promotion ou de stock limité
            const badgeHTML = product.promoPrice 
                ? `<div class="product-badge" style="background-color: var(--danger-color);">-${Math.round((1 - product.promoPrice/product.price)*100)}%</div>` 
                : (product.stock < 5 ? `<div class="product-badge">${product.stock} restant(s)</div>` : '');
            
            productCard.innerHTML = `
                <div class="product-image-container" data-product-id="${product.id}">
                    ${badgeHTML}
                    <img src="${product.image}" alt="${product.title}" class="product-image">
                </div>
                <div class="product-info">
                    <h3 class="product-title" data-product-id="${product.id}">${product.title}</h3>
                    ${priceHTML}
                    <div class="product-meta">
                        <span class="product-location">
                            <i class="fas fa-map-marker-alt"></i> ${product.city}
                        </span>
                        <span class="product-stock">
                            <i class="fas fa-box-open"></i> ${product.stock} en stock | ${product.sold || 0} vendus
                        </span>
                    </div>
                    <div class="product-actions">
                        <button onclick="fbq('track', 'Purchase', {value: 14900,currency: 'XAF' });" class="btn btn-primary buy-btn" data-product-id="${product.id}">
                            <i class="fas fa-shopping-bag"></i> Acheter
                        </button>
                        <button class="btn btn-secondary add-to-cart-btn" data-product-id="${product.id}">
                            <i class="fas fa-cart-plus"></i> Panier
                        </button>
                    </div>

                </div>
            `;
            
            return productCard;
        }

        // Configurer les écouteurs d'événements
        function setupEventListeners() {
            // Catégories
            document.querySelectorAll('.category-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.getAttribute('data-category');
                    displayProductsByCategory();
                });
            });
            
            // Recherche
            searchBox.addEventListener('input', function() {
                currentSearch = this.value;
                displayProductsByCategory();
            });
            
            // Formulaire de livraison
            deliveryInfoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitDeliveryForm();
            });
            
            skipDeliveryBtn.addEventListener('click', skipDeliveryForm);
            
            // Fermer les modals en cliquant à l'extérieur
            window.addEventListener('click', function(e) {
                if (e.target === productModal) {
                    productModal.style.display = 'none';
                }
                if (e.target === deliveryFormModal) {
                    deliveryFormModal.style.display = 'none';
                }
                if (e.target === cartModal) {
                    cartModal.style.display = 'none';
                }
                if (e.target === cartAbandonModal) {
                    cartAbandonModal.style.display = 'none';
                }
            });
            
            // Panier
            cartBtn.addEventListener('click', function() {
                cartModal.style.display = 'flex';
                resetCartAbandonmentTimer(); // Réinitialiser le timer quand l'utilisateur ouvre le panier
            });
            
            headerCartBtn.addEventListener('click', function() {
                cartModal.style.display = 'flex';
                resetCartAbandonmentTimer();
            });
            
            clearCartBtn.addEventListener('click', clearCart);
            
            checkoutBtn.addEventListener('click', function() {
                cartModal.style.display = 'none';
                preparePurchaseFromCart();
                resetCartAbandonmentTimer();
            });
        }

        // Configurer le chat WhatsApp
        function setupWhatsAppChat() {
            whatsappChatBtn.addEventListener('mouseenter', function() {
                chatTooltip.style.display = 'block';
            });
            
            whatsappChatBtn.addEventListener('mouseleave', function() {
                chatTooltip.style.display = 'none';
            });
        }

        // Configurer l'abandon de panier
        function setupCartAbandonment() {
            // Démarrer le timer d'inactivité
            resetCartAbandonmentTimer();
            
            // Bouton pour voir le panier
            viewCartBtn.addEventListener('click', function() {
                cartAbandonModal.style.display = 'none';
                cartModal.style.display = 'flex';
                resetCartAbandonmentTimer();
            });
        }

        let inactivityTimer;
        function resetCartAbandonmentTimer() {
            clearTimeout(inactivityTimer);
            if (cart.length > 0) {
                inactivityTimer = setTimeout(() => {
                    cartAbandonModal.style.display = 'flex';
                }, 30000); // 30 secondes
            }
        }

        // Mettre à jour les écouteurs d'événements après le rendu des produits
        function updateEventListeners() {
            // Clic sur image ou titre pour voir les détails
            document.querySelectorAll('.product-image-container, .product-title').forEach(element => {
                element.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    showProductDetails(productId);
                });
            });
            
            // Boutons d'achat et panier
            document.querySelectorAll('.buy-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    preparePurchase(productId);
                });
            });
            
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    addToCart(productId);
                });
            });
            
            // Boutons de partage
            document.querySelectorAll('.share-whatsapp').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    shareProduct(productId, 'whatsapp');
                });
            });
            
            
            // Liens "Voir plus"
            document.querySelectorAll('.view-more').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const category = this.getAttribute('data-category');
                    currentCategory = category;
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`.category-btn[data-category="${category}"]`).classList.add('active');
                    displayProductsByCategory();
                    
                    // Scroll vers le haut
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            });
        }

        // Afficher les détails d'un produit
        function showProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Construire le contenu du modal
            let imagesHTML = '';
            product.images.forEach((img, index) => {
                imagesHTML += `
                    <img src="${img}" class="thumbnail ${index === 0 ? 'active' : ''}" 
                        onclick="changeMainImage(this, '${img}')" alt="Miniature ${index + 1}">
                `;
            });
            
            const priceHTML = product.promoPrice 
                ? `<span class="product-old-price">${product.price.toLocaleString()} FCFA</span>
                   <span class="product-price">${product.promoPrice.toLocaleString()} FCFA</span>`
                : `<span class="product-price">${product.price.toLocaleString()} FCFA</span>`;
            
            productModalBody.innerHTML = `
                <div class="product-details">
                    <div class="product-gallery">
                        <img src="${product.images[0]}" class="main-image" id="mainProductImage" alt="${product.title}">
                        <div class="thumbnails">
                            ${imagesHTML}
                        </div>
                    </div>
                    
                    <div class="product-info-details">
                        <h2>${product.title}</h2>
                        <div class="product-price-container">
                            ${priceHTML}
                        </div>
                        
                        <div class="product-meta-details">
                            <div class="meta-item">
                                <span class="meta-label">Catégorie:</span>
                                <span class="meta-value">${
                                    product.category === 'vetements' ? 'Vêtements' : 
                                    product.category === 'accessoires' ? 'Accessoires' : 
                                    'Chaussures'
                                }</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Disponibilité:</span>
                                <span class="meta-value">${product.stock > 0 ? 
                                    `<span style="color: var(--primary-color);">En stock (${product.stock})</span>` : 
                                    '<span style="color: var(--danger-color);">Rupture de stock</span>'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Localisation:</span>
                                <span class="meta-value">${product.city}</span>
                            </div>
                        </div>
                        
                        <div class="product-description">
                            <h4>Description</h4>
                            <p>${product.description}</p>
                        </div>
                        
                        <div class="modal-actions">
                            <button onclick="fbq('track', 'Lead');" class="btn btn-primary buy-btn" data-product-id="${product.id}">
                                <i class="fas fa-shopping-bag"></i> Acheter maintenant
                            </button>
                            <button class="btn btn-secondary add-to-cart-btn" data-product-id="${product.id}">
                                <i class="fas fa-cart-plus"></i> Ajouter au panier
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Afficher le modal
            productModal.style.display = 'flex';
            
            // Ajouter les événements aux boutons dans le modal
            document.querySelectorAll('#productModalBody .buy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    productModal.style.display = 'none';
                    preparePurchase(productId);
                });
            });
            
            document.querySelectorAll('#productModalBody .add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    addToCart(productId);
                    
                    // Feedback visuel
                    this.innerHTML = '<i class="fas fa-check"></i> Ajouté !';
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-cart-plus"></i> Ajouter au panier';
                    }, 1000);
                });
            });
        }
        
        // Changer l'image principale dans le modal des détails
        function changeMainImage(element, newSrc) {
            document.getElementById('mainProductImage').src = newSrc;
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            element.classList.add('active');
        }

        // Ajouter un produit au panier
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock <= 0) return;
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity += 1;
                } else {
                    alert(`Désolé, il ne reste que ${product.stock} exemplaire(s) de ce produit.`);
                    return;
                }
            } else {
                cart.push({
                    id: product.id,
                    title: product.title,
                    price: product.promoPrice || product.price,
                    quantity: 1,
                    image: product.image
                });
            }
            
            updateCart();
            resetCartAbandonmentTimer();
            trackConversion('add_to_cart', product.promoPrice || product.price);
        }

        // Mettre à jour l'affichage du panier
        function updateCart() {
            cartItems.innerHTML = '';
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <img src="${item.image}" width="50" height="50" style="object-fit: cover; border-radius: 5px;">
                    <div class="cart-item-info">
                        <div class="cart-item-title">${item.title}</div>
                        <div class="cart-item-price">${item.price.toLocaleString()} FCFA x ${item.quantity}</div>
                    </div>
                    <div class="cart-item-total">${itemTotal.toLocaleString()} FCFA</div>
                    <div class="remove-item" data-product-id="${item.id}">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            cartTotal.textContent = total.toLocaleString();
            const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalCount;
            headerCartCount.textContent = totalCount;
            
            // Ajouter les événements pour supprimer les articles
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-product-id'));
                    removeFromCart(productId);
                });
            });
        }

        // Supprimer un article du panier
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
            resetCartAbandonmentTimer();
        }

        // Vider le panier
        function clearCart() {
            cart = [];
            updateCart();
        }

        // Préparer l'achat depuis le panier
        function preparePurchaseFromCart() {
            if (cart.length === 0) {
                alert("Votre panier est vide.");
                return;
            }
            
            if (currentUser && currentUser.addresses.length > 0) {
                // Pré-remplir le formulaire avec l'adresse par défaut
                const defaultAddress = currentUser.addresses.find(a => a.isDefault) || currentUser.addresses[0];
                if (defaultAddress) {
                    document.getElementById('clientName').value = currentUser.name;
                    document.getElementById('clientPhone').value = currentUser.phone;
                    document.getElementById('clientEmail').value = currentUser.email;
                    document.getElementById('clientCity').value = defaultAddress.city;
                    document.getElementById('clientNeighborhood').value = defaultAddress.neighborhood;
                    document.getElementById('clientAddress').value = defaultAddress.details;
                }
            }
            
            currentProductForPurchase = null;
            deliveryFormModal.style.display = 'flex';
            
            // Suivi de conversion
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            trackConversion('initiate_checkout', total);
        }

        // Préparer l'achat d'un seul produit
        function preparePurchase(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                alert("Ce produit n'est plus disponible.");
                return;
            }
            
            currentProductForPurchase = product;
            deliveryFormModal.style.display = 'flex';
            
            // Suivi de conversion
            trackConversion('begin_checkout', product.promoPrice || product.price);
        }

        // Générer le message WhatsApp
        function generateWhatsAppMessage(formData = null) {
            let message = "Bonjour Cowema,\n\nJe souhaite ";
            
            if (currentProductForPurchase) {
                // Achat d'un seul produit
                const product = currentProductForPurchase;
                message += `commander cet article :\n\n`;
                message += `*${product.title}*\n`;
                message += `Prix: ${product.promoPrice ? product.promoPrice.toLocaleString() : product.price.toLocaleString()} FCFA\n`;
                message += `Stock: ${product.stock}\n`;
                message += `Localisation: ${product.city}\n\n`;
            } else {
                // Achat depuis le panier
                message += `passer la commande suivante :\n\n`;
                cart.forEach(item => {
                    message += `- ${item.title} (${item.price.toLocaleString()} FCFA x ${item.quantity}) = ${(item.price * item.quantity).toLocaleString()} FCFA\n`;
                });
                message += `\n*Total: ${cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toLocaleString()} FCFA*\n\n`;
            }
            
            if (formData) {
                message += `Mes informations :\n`;
                message += `▸ Nom: ${formData.name}\n`;
                message += `▸ Téléphone: ${formData.phone}\n`;
                if (formData.email) message += `▸ Email: ${formData.email}\n`;
                message += `▸ Ville: ${formData.city}\n`;
                message += `▸ Quartier: ${formData.neighborhood}\n`;
                if (formData.address) message += `▸ Adresse: ${formData.address}\n`;
                if (formData.notes) message += `▸ Notes: ${formData.notes}\n`;
                
                // Calculer les frais de livraison
                const deliveryFee = deliveryFees[formData.city]?.[formData.neighborhood] || 
                                    deliveryFees[formData.city]?.["Autre"] || 
                                    deliveryFees["Autre"]["Autre"];
                
                const totalAmount = currentProductForPurchase ? 
                    (currentProductForPurchase.promoPrice || currentProductForPurchase.price) + deliveryFee :
                    cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) + deliveryFee;
                
                message += `\nFrais de livraison: ${deliveryFee.toLocaleString()} FCFA`;
                message += `\nTotal à payer: ${totalAmount.toLocaleString()} FCFA`;
            }
            
            message += `\nMerci de me confirmer la disponibilité et les modalités de livraison.`;
            
            return encodeURIComponent(message);
        }

        // Partager un produit
        function shareProduct(productId, platform) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const productUrl = encodeURIComponent(window.location.href.split('?')[0] + `?product=${productId}`);
            const productTitle = encodeURIComponent(`Découvrez "${product.title}" chez Cowema`);
            const priceText = product.promoPrice ? 
                encodeURIComponent(`Prix: ${product.promoPrice.toLocaleString()} FCFA (au lieu de ${product.price.toLocaleString()} FCFA)`) :
                encodeURIComponent(`Prix: ${product.price.toLocaleString()} FCFA`);
            
            const shareText = `${productTitle} - ${priceText}`;
            
            if (platform === 'whatsapp') {
                window.open(`https://wa.me/?text=${shareText}%0A%0A${productUrl}`, '_blank');
            } else if (platform === 'facebook') {
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${productUrl}&quote=${shareText}`, '_blank');
            }
        }

        // Soumettre le formulaire de livraison
        function submitDeliveryForm() {
            const formData = {
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                city: document.getElementById('clientCity').value,
                neighborhood: document.getElementById('clientNeighborhood').value,
                address: document.getElementById('clientAddress').value,
                notes: document.getElementById('clientNotes').value
            };
            
            const whatsappMessage = generateWhatsAppMessage(formData);
            window.open(`https://wa.me/${whatsappNumber}?text=${whatsappMessage}`, '_blank');
            deliveryFormModal.style.display = 'none';
            
            // Suivi de conversion
            if (currentProductForPurchase) {
                trackConversion('purchase', currentProductForPurchase.promoPrice || currentProductForPurchase.price);
            } else {
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                trackConversion('purchase', total);
            }
            
            // Vider le panier si c'était un achat groupé
            if (!currentProductForPurchase) {
                clearCart();
            }
        }

        // Passer directement à WhatsApp
        function skipDeliveryForm() {
            const whatsappMessage = generateWhatsAppMessage();
            window.open(`https://wa.me/${whatsappNumber}?text=${whatsappMessage}`, '_blank');
            deliveryFormModal.style.display = 'none';
            
            // Suivi de conversion
            if (currentProductForPurchase) {
                trackConversion('initiate_checkout', currentProductForPurchase.promoPrice || currentProductForPurchase.price);
            } else {
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                trackConversion('initiate_checkout', total);
            }
            
            // Vider le panier si c'était un achat groupé
            if (!currentProductForPurchase) {
                clearCart();
            }
        }

        
    !function(f,b,e,v,n,t,s)
        {if(f.fbq)
            return;n=f.fbq=function(){n.callMethod?
            n.callMethod.apply(n,arguments):n.queue.push(arguments)};
            
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
            n.queue=[];t=b.createElement(e);t.async=!0;
            t.src=v;s=b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t,s)}
            (window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
            
    fbq('init', '562190026611572');
    fbq('track', 'PageView');
    
    fbq('track', 'Lead', {value: 40.00, currency: 'USD'});
    
    function onClick() {
    fbq('track', 'Purchase');
    };

    function trackSearch() {
    // On récupère la valeur de la recherche dans l’input
    var searchQuery = document.getElementById("searchBox").value;

    // On déclenche l’événement Facebook Pixel
    fbq('track', 'Search', {
        search_string: searchQuery,
        content_ids: ['1234', '2424'], // Ids fictifs pour l'exemple
        value: 0.00,
        currency: 'XAF'
    });
};


        // Suivi des conversions
        function trackConversion(action, value = null) {
            // Ici vous intégreriez votre outil d'analyse (Google Analytics, Facebook Pixel, etc.)
            console.log(`Conversion tracked: ${action}`, value ? `Value: ${value}` : '');
            
            // Exemple pour Facebook Pixel
            if (typeof fbq !== 'undefined') {
                fbq('track', action, { value: value, currency: 'XAF' });
            }
            
            // Exemple pour Google Analytics
            if (typeof gtag !== 'undefined') {
                gtag('event', action, {
                    'event_category': 'Ecommerce',
                    'event_label': action,
                    'value': value
                });
            }
        }
        
        // Gestion de l'authentification
        function updateAuthUI() {
            if (currentUser) {
                document.getElementById('authLinks').style.display = 'none';
                document.getElementById('userMenu').style.display = 'block';
                document.getElementById('userGreeting').textContent = `Bonjour, ${currentUser.name.split(' ')[0]}`;
            } else {
                document.getElementById('authLinks').style.display = 'block';
                document.getElementById('userMenu').style.display = 'none';
            }
        }
        
        // Configurer la capture de leads
        function setupLeadCapture() {
            let scrollCount = 0;
            let hasShownPopup = localStorage.getItem('hasShownPopup') === 'true';

            window.addEventListener('scroll', function() {
                if (hasShownPopup) return;
                
                scrollCount++;
                if (scrollCount >= 2) {
                    setTimeout(() => {
                        document.getElementById('leadCaptureModal').style.display = 'flex';
                        hasShownPopup = true;
                        localStorage.setItem('hasShownPopup', 'true');
                        
                        // Afficher l'image seulement sur desktop
                        if (window.innerWidth > 768) {
                            document.querySelector('.lead-image').style.display = 'block';
                        }
                    }, 2000);
                }
            });

            // Fermer le popup
            document.querySelector('#leadCaptureModal .close-modal').addEventListener('click', function() {
                document.getElementById('leadCaptureModal').style.display = 'none';
            });

            // Soumettre le formulaire
            document.getElementById('leadCaptureForm').addEventListener('submit', function(e) {
                e.preventDefault();
                alert('Merci! Vous serez informé de nos meilleures offres.');
                document.getElementById('leadCaptureModal').style.display = 'none';
            });
        }

        // Démarrer l'application
        init();
        
        // Exposer des fonctions au scope global pour les événements inline
        window.changeMainImage = changeMainImage;
        
        // Gestion de l'authentification
        document.getElementById('loginLink').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('loginModal').style.display = 'flex';
        });

        document.getElementById('registerLink').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('registerModal').style.display = 'flex';
        });

        document.getElementById('logoutLink').addEventListener('click', function(e) {
            e.preventDefault();
            currentUser = null;
            localStorage.removeItem('cowema_currentUser');
            updateAuthUI();
        });

        document.querySelector('.account-link').addEventListener('click', function(e) {
            e.preventDefault();
            if (currentUser) {
                document.getElementById('accountName').value = currentUser.name;
                document.getElementById('accountEmail').value = currentUser.email;
                document.getElementById('accountPhone').value = currentUser.phone;
                document.getElementById('accountModal').style.display = 'flex';
            }
        });

        // Gestion des formulaires
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('cowema_currentUser', JSON.stringify(currentUser));
                document.getElementById('loginModal').style.display = 'none';
                updateAuthUI();
                alert('Connexion réussie!');
            } else {
                alert('Email ou mot de passe incorrect');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Les mots de passe ne correspondent pas');
                return;
            }
            
            if (users.some(u => u.email === email)) {
                alert('Un compte existe déjà avec cet email');
                return;
            }
            
            const newUser = {
                id: Date.now(),
                name,
                email,
                phone,
                password,
                addresses: [],
                orders: []
            };
            
            users.push(newUser);
            localStorage.setItem('cowema_users', JSON.stringify(users));
            
            currentUser = newUser;
            localStorage.setItem('cowema_currentUser', JSON.stringify(currentUser));
            
            document.getElementById('registerModal').style.display = 'none';
            updateAuthUI();
            alert('Inscription réussie! Bienvenue chez Cowema!');
        });

        // Navigation entre modals
        document.getElementById('showRegisterBtn').addEventListener('click', function() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('registerModal').style.display = 'flex';
        });

        document.getElementById('showLoginBtn').addEventListener('click', function() {
            document.getElementById('registerModal').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
        });

        // Gestion des onglets du compte
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(`${this.dataset.tab}Tab`).classList.add('active');
            });
        });

        // Gestion des adresses
        document.getElementById('addAddressBtn').addEventListener('click', function() {
            document.getElementById('addressForm').reset();
            document.getElementById('addressModal').style.display = 'flex';
        });

        document.getElementById('addressForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const address = {
                id: document.getElementById('addressId').value || Date.now(),
                city: document.getElementById('addressCity').value,
                neighborhood: document.getElementById('addressNeighborhood').value,
                details: document.getElementById('addressDetails').value,
                isDefault: document.getElementById('addressDefault').checked
            };
            
            if (address.isDefault) {
                currentUser.addresses.forEach(a => a.isDefault = false);
            }
            
            // Si c'est une modification
            if (document.getElementById('addressId').value) {
                const addressId = parseInt(document.getElementById('addressId').value);
                currentUser.addresses = currentUser.addresses.map(a => 
                    a.id === addressId ? address : a
                );
            } else {
                // Nouvelle adresse
                currentUser.addresses.push(address);
            }
            
            users = users.map(u => u.id === currentUser.id ? currentUser : u);
            
            localStorage.setItem('cowema_users', JSON.stringify(users));
            localStorage.setItem('cowema_currentUser', JSON.stringify(currentUser));
            
            document.getElementById('addressModal').style.display = 'none';
            loadUserAddresses();
        });

        function loadUserAddresses() {
            const container = document.getElementById('deliveryAddresses');
            container.innerHTML = '';
            
            if (currentUser.addresses.length === 0) {
                container.innerHTML = '<p>Aucune adresse enregistrée</p>';
                return;
            }
            
            currentUser.addresses.forEach(address => {
                const addressElement = document.createElement('div');
                addressElement.className = 'address-item';
                addressElement.style.border = '1px solid var(--border-color)';
                addressElement.style.padding = '15px';
                addressElement.style.marginBottom = '10px';
                addressElement.style.borderRadius = '5px';
                addressElement.style.position = 'relative';
                
                addressElement.innerHTML = `
                    <div style="font-weight: bold;">${address.city}, ${address.neighborhood}</div>
                    <div>${address.details}</div>
                    ${address.isDefault ? '<div style="color: var(--primary-color); margin-top: 5px;"><i class="fas fa-check-circle"></i> Adresse par défaut</div>' : ''}
                    <div style="position: absolute; top: 10px; right: 10px;">
                        <button class="edit-address" data-id="${address.id}" style="background: none; border: none; cursor: pointer; color: var(--secondary-color);">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-address" data-id="${address.id}" style="background: none; border: none; cursor: pointer; color: var(--danger-color); margin-left: 5px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(addressElement);
            });
            
            // Ajouter les événements pour les boutons
            document.querySelectorAll('.edit-address').forEach(btn => {
                btn.addEventListener('click', function() {
                    const addressId = parseInt(this.dataset.id);
                    const address = currentUser.addresses.find(a => a.id === addressId);
                    
                    if (address) {
                        document.getElementById('addressId').value = address.id;
                        document.getElementById('addressCity').value = address.city;
                        document.getElementById('addressNeighborhood').value = address.neighborhood;
                        document.getElementById('addressDetails').value = address.details;
                        document.getElementById('addressDefault').checked = address.isDefault;
                        
                        document.getElementById('addressModal').style.display = 'flex';
                    }
                });
            });
            
            document.querySelectorAll('.delete-address').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Supprimer cette adresse?')) {
                        const addressId = parseInt(this.dataset.id);
                        currentUser.addresses = currentUser.addresses.filter(a => a.id !== addressId);
                        
                        users = users.map(u => u.id === currentUser.id ? currentUser : u);
                        localStorage.setItem('cowema_users', JSON.stringify(users));
                        localStorage.setItem('cowema_currentUser', JSON.stringify(currentUser));
                        
                        loadUserAddresses();
                    }
                });
            });
        }

    //choix la ville et de l'arrondissement
    const neighborhoodSelect = document.getElementById("clientNeighborhood");
    const villeSelect = document.getElementById("clientCity");
    
// Lorsqu'une ville est sélectionnée
    villeSelect.addEventListener("change", () => {
        const selectedVille = villeSelect.value;

      // On vide les anciens arrondissements
        neighborhoodSelect.innerHTML = '<option value=""> Choisir un arrondissement </option>';

      // Si une ville valide est choisie, on ajoute ses arrondissements
        if (selectedVille && deliveryFees[selectedVille]) {
        const arrondissements = Object.keys(deliveryFees[selectedVille]);
        arrondissements.forEach(arr => {
            const option = document.createElement("option");
            option.value = arr;
            option.textContent = arr;
            neighborhoodSelect.appendChild(option);
        });
    }
    });
